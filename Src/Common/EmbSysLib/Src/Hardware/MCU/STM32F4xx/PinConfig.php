<?php
//*******************************************************************
/*!
\file   PinConfig.php
\author Thomas Breuer (Bonn-Rhein-Sieg University of Applied Sciences)
\date   16.10.2022

License: See file "LICENSE"
*/

  $inputFileName = $argv[1];
  echo "//###################################################################\n";
  echo "//\n";
  echo "// DON'T EDIT!\n";
  echo "//\n";
  echo "// This file is auto generated by\n";
  echo "//    >php -f ".$argv[0]." ".$argv[1]."\n";
  echo "//\n";
  echo "//###################################################################\n";
?>

<?php
//*******************************************************************
$lines     = file($inputFileName);
$pinConfig = array();
$pinFunc   = array();

foreach($lines AS $line)
{
  $token  = explode(",", str_replace(array("\r","\n","\""),array("","",""),$line) );
  if( substr($token[0],0,1) == "#" )
  {
    continue;
  }
  $gpio   = $token[0];
  $analog = $token[2];
  $port   = ord(substr($gpio,1,1))-ord("A");
  $pin    = substr($gpio,2,2);

  if( $analog != "" )
  {
    foreach( explode("/", $analog) AS $a )
    {
      $pinConfig[] = array("func" => $a,
                 "gpio" => $gpio,
                 "name" => $a."_".$gpio,
                 "port" => $port,
                 "pin"  => $pin,
                 "af"   => 0);

       if( !in_Array( $a, $pinFunc) )
       {
         $pinFunc[] = $a;
       }
    }
  }

  for( $col=3; $col < count($token); $col++ )
  {
    $func = $token[$col];
    if( $func != "" )
    {
      foreach( explode("/", $func) AS $f )
      {
        $pinConfig[] = array("func" => $f,
                   "gpio" => $gpio,
                   "name" => $f."_".$gpio,
                   "port" => $port,
                   "pin"  => $pin,
                   "af"   => $col-3);

         if( !in_Array( $f, $pinFunc) )
         {
           $pinFunc[] = $f;
         }
      }
    }
   }
}

array_multisort( $pinConfig );
sort( $pinFunc );
//*******************************************************************
?>

//*******************************************************************
#include "Mcu_Types.h"
#include "Std/Report.h"

//*******************************************************************
namespace EmbSysLib {
namespace Hw {

//*******************************************************************
/*!
\class PinConfig

\brief Port pin configuration

This class provides methods to
- configure GPIO mode, type, pull-up/-down, speed and alternate
  function
- connect a GPIO to an alternate function
*/
class PinConfig
{
  public:
    //---------------------------------------------------------------
    /*! \enum MODE
        \brief Pin mode configuration
    */
    typedef enum
    {
      // MODER
      INPUT          = 0x0000, //!< Input mode
      OUTPUT         = 0x0001, //!< Output mode
      ALTERNATE_FUNC = 0x0002, //!< Alternate function
      ANALOG         = 0x0003, //!< Analog I/O

      // OTYPER
      PUSH_PULL      = 0x0000, //!< Enable push-pull
      OPEN_DRAIN     = 0x0010, //!< Disable push-pull

      //PUPDR
      NO_PUPD        = 0x0000, //!< No pull-up or pull down
      PULL_UP        = 0x0100, //!< Enable pull-up
      PULL_DOWN      = 0x0200, //!< Enable pull-down

      //OSPEEDR
      LOW_SPEED      = 0x0000, //!< Low speed mode
      MEDIUM_SPEED   = 0x1000, //!< Medium speed mode
      FAST_SPEED     = 0x2000, //!< Fast speed mode
      HIGH_SPEED     = 0x3000  //!< High speed mode

    } MODE;

    //---------------------------------------------------------------
    /*! Alternate functions of the MCU
    */
    typedef enum
    { <?php
        printf("\n");
        foreach($pinFunc AS $f)
        {
          printf("      %s,\n",$f);
        }
      ?>
    } Function;

    //---------------------------------------------------------------
    /*! Pin function mapping

        Maps an alternate function to a port pin and alternate function ID.
       'ADC12_IN4_PA4' means: The function 'ADC12_IN4' is mapped to pin PA4
    */
    typedef enum
    { <?php
        printf("\n");
        foreach($pinConfig AS $a)
        {
           printf("      %-20s = (%-20s<<16)|(%2s<<12)|(%2s<<4)|(%2s<<0), //!<\\n\n",
                  $a["name"], $a["func"], $a["port"], $a["pin"], $a["af"]);
        }
      ?>
      END_OF_TABLE = -1
    } MAP;

  public:
    //---------------------------------------------------------------
    /*! Set configuration of a GPIO
        \param gpio  Pointer to function register.
                     Use predefined constant \a 'GPIOx'
        \param pinId GPIO pin number (0,...15)
        \param mode  Selected pin mode.
                     Use constants defined in \b MODE, the constants
                     can be combined using bit-or operations.
        \param af    Number of selected alternate function. This
                     parameter is used only, when \b ALTERNATE_FUNC
                     is selected.
    */
    static void set( GPIO_TypeDef *gpio,
                     BYTE          pinId,
                     DWORD         mode,
                     BYTE          af = 0 );

    //---------------------------------------------------------------
    /*! Set GPIO to alternate function

        A GPIO can be connected to a onchip peripheral module. The
        enum \b 'Function' lists all peripheral signals which can be
        connected to a GPIO. This method uses a application specific
        mapping \b 'table'. The application has to define
        this \b 'table' on global scope. The entries of this table
        define on which port pin a peripheral signal is mapped.
        \param func  Selected peripheral signal as alternate function
        \param mode  Selected pin mode.
                     Use constants defined in \b MODE, the constants
                     can be combined using bit-or operations.
        \return
                - true, if \b func is included in \b table
                - false otherwise
    */
    static bool set( Function func,
                     DWORD    mode = 0 );

  public:
    //---------------------------------------------------------------
    /*! This table defines how an alternate function is mapped to the
        port pins. It must be defined by application software. The
        last entry of this table has to be \b 'END_OF_TABLE'.
    */
    static MAP table[];
    static Std::Report report;

}; //PinConfig

}  } //namespace
